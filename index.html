<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script>
      var format = {
        "string": function(t) { return t;},
        "float": d3.format(".1f"),
        "gdp" : d3.format(".2s")
      };

      var neededColumns = [
        {
          title: "name",
          format: format["string"]
        },
        {
          title: "continent",
          format: format["string"]
        },
        {
          title: "gdp",
          format: format["gdp"]
        },
        {
          title: "life_expectancy",
          format: format["float"]
        },
        {
          title: "population",
          format: format["string"]
        },
        {
          title: "year",
          format: format["string"]
        }
      ];

      var sortedTitle = '';

      d3.json("https://alexanderkub.github.io/DataVis/data/countries_2012.json", function(error, data) {

        var table = d3.select("body").append("table")
          .classed('country-table', true);
        var thead = table.append("thead");
        var tbody = table.append("tbody");

        table.append("caption")
          .html("World Countries Ranking");

        var sortedThElement;
        thead.append("tr").selectAll("th")
          .data(neededColumns)
          .enter().append("th")
          .text(function(d) { return d.title; })
          .classed("center-text", true)
          .on("click", function(header, i) {
            var ascending = sortedTitle != header.title;
            sortedTitle = ascending ? header.title : '';

            if (sortedThElement) {
              sortedThElement.classed('up-arrowed', false);
              sortedThElement.classed('down-arrowed', false);
            }
            sortedThElement = d3.select(this);
            sortedThElement.classed('up-arrowed', ascending);
            sortedThElement.classed('down-arrowed', !ascending);

            tbody.selectAll("tr").sort(function(a, b) {
              if (ascending) {
                return d3.ascending(a[header.title], b[header.title])
                  || d3.ascending(a['name'], b['name']);
              }
              return d3.descending(a[header.title], b[header.title])
                || d3.ascending(a['name'], b['name']);
            });
          });

        var rows = tbody.selectAll("tr.row").data(data)
          .enter().append("tr").attr("class", "row");

        var cells = rows.selectAll("td").data(function(row) {
          return neededColumns.map(function(column, i) {
            return column.format(row[column.title]);
          });
        }).enter().append("td").text(function(d) { return d; })
          .attr("class", function(d, i) {
            return i < 2 ? "center-text" : "right-text";
          })
          .on("mouseover", function(d, i) {
            d3.select(this.parentNode).style("background-color", "#F3ED86");
          })
          .on("mouseout", function() {
            tbody.selectAll("tr").style("background-color", null)
              .selectAll("td").style("background-color", null);
          });
      });
    </script>
  </body>
</html>
